# Production Environment Override
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

version: '3.8'

services:
  dashboard:
    # Use pre-built image from registry instead of building locally
    image: ghcr.io/yourusername/claude-code-dashboard:${IMAGE_TAG:-latest}

    environment:
      - NODE_ENV=production
      - DEBUG=false
      - LOG_LEVEL=warn
      # Load JWT_SECRET from Docker secret file
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - ALLOWED_FILE_ROOTS=/projects
      - ALLOWED_PROJECT_ROOTS=/projects
      - DB_PATH=/app/data/dashboard.db
      # Disable ngrok by default in production
      - ENABLE_NGROK=false

    # Use secrets instead of plain environment variables
    secrets:
      - jwt_secret
      - admin_password

    volumes:
      # Projects and data only - no source code
      - ${PROJECT_DIR:-/mnt/projects}:/projects:rw
      - dashboard_data:/app/data
      # Claude config (read-only)
      - ${HOME}/.claude:/home/claude/.claude:ro

    ports:
      # Bind to localhost only
      - "127.0.0.1:3000:3000"

    security_opt:
      - no-new-privileges:true

    # Strict read-only filesystem
    read_only: true

    tmpfs:
      - /tmp:noexec,nosuid,nodev
      - /run/secrets:noexec,nosuid,nodev

    # Minimal capabilities
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=claude-dashboard,version=${IMAGE_TAG:-latest}"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: always

    # Production networking
    networks:
      - dashboard-network

  # Optional: Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    profiles: ["with-nginx"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl/certs:/etc/nginx/certs:ro
    depends_on:
      - dashboard
    networks:
      - dashboard-network
    restart: always
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run

networks:
  dashboard-network:
    driver: bridge

volumes:
  dashboard_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_MOUNT_PATH:-/var/lib/claude-dashboard}

# Define secrets
secrets:
  jwt_secret:
    file: ${JWT_SECRET_FILE:-./.secrets/jwt_secret.txt}
  admin_password:
    file: ${ADMIN_PASSWORD_FILE:-./.secrets/admin_password.txt}
